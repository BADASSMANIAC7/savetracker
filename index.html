<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Savings Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0288d1;
      --secondary: #2ecc71;
      --danger: #e74c3c;
      --text: #1a237e;
      --text-light: #78909c;
      --background: #e3f2fd;
      --card-bg: rgba(255, 255, 255, 0.7);
      --card-border: rgba(255, 255, 255, 0.2);
      --shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --font-size-base: clamp(14px, 2vw, 15px);
      --spacing-unit: 1.5rem;
      --neumorphic-shadow: 6px 6px 18px rgba(0, 0, 0, 0.12), -6px -6px 18px rgba(255, 255, 255, 0.6);
    }

    [data-theme="dark"] {
      --primary: #4fc3f7;
      --secondary: #66bb6a;
      --danger: #ef5350;
      --text: #e0f7fa;
      --text-light: #90a4ae;
      --background: #333;
      --card-bg: rgba(33, 34, 35, 0.6);
      --card-border: rgba(66, 66, 66, 0.3);
      --shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      --neumorphic-shadow: 6px 6px 18px rgba(0, 0, 0, 0.5), -6px -6px 15px rgba(66, 66, 66, 0.3);
    }

    .container * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--background), #b3e5fc);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: calc(var(--spacing-unit) * 0.5);
      font-size: var(--font-size-base);
      transition: var(--transition);
      overflow-x: hidden;
    }

    h1 {
      font-size: clamp(1.8rem, 5vw, 2.4rem);
      font-weight: 700;
      text-align: center;
      margin-bottom: var(--spacing-unit);
      color: var(--primary);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: fadeIn 1s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes ripple {
      to { transform: scale(4); opacity: 0; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .container {
      max-width: 1200px;
      width: 100%;
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: var(--spacing-unit);
      margin-bottom: calc(var(--spacing-unit) * 2);
      animation: fadeIn 0.8s ease-out;
      display: grid;
      gap: calc(var(--spacing-unit) * 0.8);
      scroll-snap-type: y proximity;
    }

    .theme-toggle {
      position: fixed;
      bottom: calc(var(--spacing-unit) * 0.5);
      right: calc(var(--spacing-unit) * 0.5);
      padding: 0.8rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.4rem;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--neumorphic-shadow);
      transition: var(--transition);
      z-index: 1000;
      animation: pulse 2s infinite;
    }

    .theme-toggle:active {
      transform: scale(0.95);
    }

    form {
      position: relative;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: calc(var(--spacing-unit) * 0.8);
      background: linear-gradient(145deg, var(--card-bg), rgba(255, 255, 255, 0.05));
      padding: calc(var(--spacing-unit) * 1.2);
      border-radius: var(--border-radius);
      box-shadow: var(--neumorphic-shadow);
      border: 1px solid transparent;
      background-clip: padding-box;
      min-height: 300px;
      animation: gradientShift 10s ease infinite;
      background-size: 200% 200%;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    form::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: calc(var(--border-radius) + 2px);
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      z-index: -1;
    }

    form .form-group {
      position: relative;
      margin-bottom: 0.6rem;
    }

    form input,
    form select {
      width: 100%;
      padding: 1rem 1.2rem;
      font-size: var(--font-size-base);
      line-height: 1.6;
      border: none;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.95);
      transition: var(--transition);
      box-shadow: var(--neumorphic-shadow);
      min-height: 48px;
    }

    form input:focus,
    form select:focus {
      box-shadow: 0 0 8px var(--primary), inset 0 2px 4px rgba(0, 0, 0, 0.1);
      outline: 3px solid var(--primary);
    }

    form label {
      position: absolute;
      top: 1rem;
      left: 1.2rem;
      font-size: 0.95rem;
      color: var(--text-light);
      transition: var(--transition);
      pointer-events: none;
    }

    form input:focus + label,
    form input:not(:placeholder-shown) + label,
    form select:focus + label,
    form select:not([value=""]) + label {
      top: -0.8rem;
      left: 0.8rem;
      font-size: 0.8rem;
      color: var(--primary);
      background: var(--card-bg);
      padding: 0 0.3rem;
    }

    form button {
      background: linear-gradient(90deg, var(--secondary), #27ae60);
      color: white;
      border: none;
      font-weight: 600;
      padding: 1rem;
      border-radius: 10px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      box-shadow: var(--neumorphic-shadow);
      min-height: 48px;
      font-size: clamp(15px, 2vw, 17px);
    }

    form button::after {
      content: '';
      position: absolute;
      top: var(--y, 50%);
      left: var(--x, 50%);
      width: 0;
      height: 0;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    form button:active::after {
      width: 250px;
      height: 250px;
    }

    form button:active {
      transform: scale(0.95);
    }

    form .form-error {
      position: sticky;
      top: 0;
      background: var(--danger);
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 0.8rem;
      text-align: center;
      animation: shake 0.3s ease;
      box-shadow: var(--shadow);
      grid-column: 1 / -1;
      z-index: 10;
    }

    .entries-list {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .entries-list .entries-header {
      background: linear-gradient(90deg, var(--primary), #039be5);
      color: white;
      padding: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .entries-list .entries-header::after {
      content: 'â–¼';
      font-size: 0.8rem;
      transition: transform 0.3s;
    }

    .entries-list .entries-header.collapsed::after {
      transform: rotate(180deg);
    }

    .entries-list .entries-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .entries-list .entries-content.show {
      max-height: 1000px;
    }

    .entries-list .entry {
      display: flex;
      flex-direction: column;
      padding: 0.8rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      background: var(--card-bg);
      transform: translateX(0);
      transition: transform 0.3s ease;
    }

    .entries-list .entry.swipe-left {
      transform: translateX(-100px);
    }

    .entries-list .entry-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .entries-list .entry-details {
      max-height: 0;
      overflow: hidden;
      font-size: 0.85rem;
      color: var(--text-light);
      transition: max-height 0.3s ease;
    }

    .entries-list .entry-details.show {
      max-height: 100px;
      margin-top: 0.5rem;
    }

    button.delete-btn {
      background: var(--danger);
      border: none;
      color: white;
      padding: 0.6rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      box-shadow: var(--neumorphic-shadow);
    }

    button.delete-btn:active {
      transform: scale(0.95);
    }

    .goals {
      display: grid;
      gap: calc(var(--spacing-unit) * 0.8);
    }

    .goals .goal {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius);
      padding: calc(var(--spacing-unit) * 0.8);
      box-shadow: var(--shadow);
      animation: slideIn 0.6s ease-out;
      scroll-snap-align: start;
    }

    .goals .goal h3 {
      font-size: clamp(1rem, 2.5vw, 1.15rem);
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.6rem;
    }

    .goals .goal .progress-bar {
      background: rgba(0, 0, 0, 0.15);
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
    }

    .goals .goal .progress-bar .progress-bar-fill {
      height: 100%;
      width: 0;
      background: var(--secondary);
      border-radius: 10px 0 0 10px;
      transition: width 1.5s ease-in-out;
      position: relative;
      overflow: hidden;
    }

    .goals .goal .progress-bar .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(
        45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 20px 20px;
      animation: moveStripes 1.5s linear infinite;
    }

    .goals .goal .progress-bar .progress-bar-fill.milestone-25 { background: #f39c12; }
    .goals .goal .progress-bar .progress-bar-fill.milestone-50 { background: #e67e22; }
    .goals .goal .progress-bar .progress-bar-fill.milestone-75 { background: #d35400; }
    .goals .goal .progress-bar .progress-bar-fill.milestone-100 { background: var(--secondary); }

    .goals .goal .progress-text {
      margin-top: 0.5rem;
      font-weight: 500;
      color: var(--text);
      font-size: 0.9rem;
    }

    .goals .goal .goal-chart-container {
      max-width: 250px;
      margin: 0.8rem auto;
      padding: 0.6rem;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    @keyframes moveStripes {
      0% { background-position: 0 0; }
      100% { background-position: 40px 40px; }
    }

    .charts-targets {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: calc(var(--spacing-unit) * 0.8);
      margin: var(--spacing-unit) auto;
      max-width: 1200px;
    }

    .charts-targets .chart-container,
    .charts-targets .targets-container {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border: 1px solid var(--card-border);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: calc(var(--spacing-unit) * 0.8);
      animation: fadeIn 0.8s ease-out;
    }

    .targets-container {
      display: grid;
      gap: calc(var(--spacing-unit) * 0.5);
      position: sticky;
      top: 0;
    }

    .targets-container h3 {
      font-size: clamp(1rem, 2.5vw, 1.15rem);
      font-weight: 600;
      color: var(--text);
      text-align: center;
    }

    .targets-container .target {
      padding: 0.8rem;
      border-radius: 8px;
      background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      font-size: 0.9rem;
      box-shadow: var(--neumorphic-shadow);
    }

    .targets-container .target h4 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .targets-container .target .status-met {
      color: var(--secondary);
      font-weight: 600;
    }

    .targets-container .target .status-unmet {
      color: var(--danger);
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .targets-container .target .status-unmet .deadline-text {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-left: 0.3rem;
    }

    .notification {
      position: fixed;
      bottom: calc(var(--spacing-unit) * 2);
      right: calc(var(--spacing-unit) * 0.5);
      background: linear-gradient(90deg, var(--secondary), #27ae60);
      color: white;
      padding: 0.8rem 1.2rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events: none;
      transition: var(--transition);
      font-weight: 600;
      z-index: 1000;
      transform: translateY(30px);
      min-width: 200px;
      text-align: center;
    }

    .notification.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation: none !important;
        transition: none !important;
      }
    }

    @media (max-width: 768px) {
      :root {
        --spacing-unit: 1rem;
        --font-size-base: clamp(13px, 2vw, 14px);
      }

      body {
        padding: calc(var(--spacing-unit) * 0.5);
      }

      h1 {
        font-size: clamp(1.6rem, 4vw, 2rem);
      }

      .container {
        padding: calc(var(--spacing-unit) * 0.8);
        gap: calc(var(--spacing-unit) * 0.6);
        border-radius: 10px;
        max-width: 95vw;
      }

      .theme-toggle {
        bottom: calc(var(--spacing-unit) * 1.5);
        right: calc(var(--spacing-unit) * 1.5);
        width: 44px;
        height: 44px;
        font-size: 1.2rem;
      }

      form#entry-form {
        grid-template-columns: 1fr;
        padding: calc(var(--spacing-unit) * 1.5);
        gap: 1rem;
        min-height: 400px;
        margin: 0 auto;
        max-width: 95vw;
      }

      form#entry-form input,
      form#entry-form select {
        padding: 1.2rem;
        font-size: var(--font-size-base);
        line-height: 1.6;
        min-height: 52px;
      }

      form#entry-form label {
        font-size: 0.9rem;
        top: 1.2rem;
        left: 1.2rem;
      }

      form#entry-form input:focus + label,
      form#entry-form input:not(:placeholder-shown) + label,
      form#entry-form select:focus + label,
      form#entry-form select:not([value=""]) + label {
        top: -1rem;
        font-size: 0.85rem;
      }

      form#entry-form button {
        padding: 1.2rem;
        font-size: var(--font-size-base);
        min-height: 52px;
      }

      form#entry-form .form-error {
        font-size: 0.95rem;
        padding: 1rem;
      }

      .entries-list .entry {
        padding: 0.6rem;
      }

      .entries-list .entry-main {
        font-size: 0.9rem;
      }

      .entries-list .entry-details {
        font-size: 0.8rem;
      }

      .goals {
        gap: calc(var(--spacing-unit) * 0.6);
      }

      .goals .goal {
        padding: calc(var(--spacing-unit) * 0.6);
      }

      .goals .goal h3 {
        font-size: 1rem;
      }

      .goals .goal .progress-text {
        font-size: 0.85rem;
      }

      .goals .goal .goal-chart-container {
        max-width: 90vw;
        padding: 0.5rem;
      }

      .charts-targets {
        grid-template-columns: 1fr;
        gap: calc(var(--spacing-unit) * 0.6);
      }

      .charts-targets .chart-container,
      .charts-targets .targets-container {
        padding: calc(var(--spacing-unit) * 0.6);
      }

      .charts-targets .chart-container canvas {
        max-width: 90vw;
      }

      .targets-container {
        position: static;
      }

      .targets-container .target {
        font-size: 0.85rem;
      }

      .targets-container .target h4 {
        font-size: 0.95rem;
      }

      .targets-container .target .status-unmet .deadline-text {
        font-size: 0.8rem;
        margin-left: 0.2rem;
      }

      .notification {
        bottom: calc(var(--spacing-unit) * 7);
        right: calc(var(--spacing-unit) * 0.5);
        min-width: 180px;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: clamp(1.4rem, 3.5vw, 1.8rem);
      }

      .theme-toggle {
        width: 40px;
        height: 40px;
        font-size: 1.1rem;
      }

      form#entry-form {
        padding: calc(var(--spacing-unit) * 1.2);
        min-height: 360px;
      }

      form#entry-form input,
      form#entry-form select {
        padding: 1rem;
        min-height: 48px;
      }

      form#entry-form button {
        padding: 1rem;
      }
    }

    @media (max-width: 360px) {
      form#entry-form {
        padding: calc(var(--spacing-unit) * 1);
        min-height: 340px;
      }

      form#entry-form input,
      form#entry-form select {
        padding: 0.9rem;
        font-size: clamp(12px, 1.8vw, 14px);
      }

      form#entry-form button {
        padding: 0.9rem;
      }

      form#entry-form .form-error {
        font-size: 0.9rem;
      }
    }

    @media (orientation: landscape) and (max-width: 768px) {
      .charts-targets {
        grid-template-columns: 1fr 1fr;
      }

      form#entry-form {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        min-height: 300px;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" aria-label="Toggle dark mode">ðŸŒ™</button>
  <h1>Savings Tracker</h1>
  <div class="container">
    <form id="entry-form" aria-labelledby="entry-form-title">
      <h2 id="entry-form-title" style="display: none;">Add Savings Entry</h2>
      <div class="form-group">
        <input type="date" id="entry-date" aria-label="Entry date" required />
        <label for="entry-date">Date</label>
      </div>
      <div class="form-group">
        <input type="number" id="entry-amount" min="0.01" step="0.01" placeholder=" " aria-label="Savings amount" required />
        <label for="entry-amount">Amount</label>
      </div>
      <div class="form-group">
        <select id="entry-goal" aria-label="Associated goal" required>
          <option value="" disabled selected>Select Goal</option>
          <option value="General">General</option>
        </select>
        <label for="entry-goal">Goal</label>
      </div>
      <div class="form-group">
        <select id="entry-category" aria-label="Savings category" required>
          <option value="" disabled selected>Category</option>
          <option>Emergency Fund</option>
          <option>Vacation</option>
          <option>Education</option>
          <option>Retirement</option>
          <option>Other</option>
        </select>
        <label for="entry-category">Category</label>
      </div>
      <div class="form-group">
        <input type="text" id="entry-notes" placeholder=" " aria-label="Notes" />
        <label for="entry-notes">Notes</label>
      </div>
      <button type="submit">Add Saving</button>
    </form>

    <div class="entries-list">
      <div class="entries-header" id="entries-toggle">Savings Entries</div>
      <div class="entries-content" id="entries-content">
        <div id="entries-list"></div>
      </div>
    </div>

    <form id="goal-form" aria-labelledby="goal-form-title">
      <h2 id="goal-form-title" style="display: none;">Add Savings Goal</h2>
      <div class="form-group">
        <input type="text" id="goal-name" placeholder=" " aria-label="Goal name" required />
        <label for="goal-name">Goal Name</label>
      </div>
      <div class="form-group">
        <input type="number" id="goal-target" min="0.01" step="0.01" placeholder=" " aria-label="Target amount" required />
        <label for="goal-target">Target Amount</label>
      </div>
      <div class="form-group">
        <input type="date" id="goal-deadline" aria-label="Goal deadline" required />
        <label for="goal-deadline">Deadline</label>
      </div>
      <button type="submit">Add Goal</button>
    </form>

    <div class="goals" id="goals-container"></div>

    <div class="charts-targets">
      <div class="chart-container">
        <canvas id="general-savings-chart" aria-label="General savings distribution by category"></canvas>
      </div>
      <div class="targets-container" id="targets-container" aria-live="polite">
        <h3>Savings Targets</h3>
        <div id="targets-list"></div>
      </div>
    </div>
  </div>

  <div class="notification" id="notification" role="alert" aria-live="assertive"></div>

  <script>
    const STORAGE_KEYS = {
      entries: 'savingTrackerEntries',
      goals: 'savingTrackerGoals',
      theme: 'savingTrackerTheme'
    };

    const entryForm = document.getElementById('entry-form');
    const entriesList = document.getElementById('entries-list');
    const entriesToggle = document.getElementById('entries-toggle');
    const entriesContent = document.getElementById('entries-content');
    const goalForm = document.getElementById('goal-form');
    const goalsContainer = document.getElementById('goals-container');
    const targetsList = document.getElementById('targets-list');
    const notificationEl = document.getElementById('notification');
    const themeToggle = document.querySelector('.theme-toggle');
    const goalSelect = document.getElementById('entry-goal');
    let charts = [];

    function loadData() {
      try {
        const data = JSON.parse(localStorage.getItem('data'));
        return data && Array.isArray(data) ? data : [];
      } catch (e) {
        console.error('Error loading data:', e);
        return [];
      }
    }

    let entries = loadData();
    let goals = loadData();

    const savedTheme = localStorage.getItem('theme');
    document.documentElement.setAttribute('data-theme', savedTheme || 'light');
    themeToggle.innerText = savedTheme' || 'ðŸŒ™';

    themeToggle.addEventListener('click', () => {
      const currentTheme = documentElement.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme == 'light' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', 'newTheme');
      localStorage.setItem('theme', 'newTheme');
      themeToggle.innerText = newTheme' === 'dark' ? ' ' : 'ðŸŒ™';
      showNotification('Dark mode ${newTheme}!');
      if ('vibrate' in navigation) navigator.vibrate(50);
      updateChart();
    });

    function saveData() {
      localStorage.setItem(STORAGE_KEYS.entries, JSON.stringify(entries));
      localStorage.setItem('goals', JSON.stringify(entries));
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Invalid Date';
      const d = new Date(dateStr);
      return isNaN(d.getTime()) ? 'Invalid Date' : d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function showNotification(message) {
      notificationEl.textContent = message;
      notificationEl.classList.add('show');
      setTimeout(() => {
        notificationEl.classList.remove('show');
      }, 6000);
    }

    function showFormError(message, formId) {
      const existingError = document.getElementById('id${formId}');
      if (existingError) {
        existingError.remove();
      }
      const errorEl = document.createElement('div');
      errorEl.className = 'error-content';
      errorEl.setAttribute('role', 'alert');
      errorEl.setAttribute('aria-describedby', 'id-${formId}');
      errorEl.id = 'error-${formId}';
      errorEl.textContent = message;
      document.getElementById(formId)).prepend(errorEl);
      setTimeout(() => {
        errorEl.remove();
      }, 4000);
      if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
    }

    function getWeekStartEnd(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday start
      const start = new Date(d.setDate(diff));
      start.setHours(0, 0, 0, 0);
      const end = new Date(start);
      end.setDate(start.getDate() + 6); // Sunday end
      end.setHours(end.setHours(23, 59, 59, 999));
      return { start, end };
    }

    function getMonthStartEnd(date) {
      const d = new Date();
      const start = new Date(d.getFullYear(), d.getMonth());
      const start.setDate(1);
      start.setHours(0, 0, 0, 0);
      const end = new Date(d.getFullYear(), d.getMonth());
 + 1);
      end.setDate(0);
      end.setHours(23,59,59,59,999);
      return { start, end };
    }

    function calculateWeeksUntil(deadline) {
      const now = new Date();
      const target = new Date(deadline);
      if (target < now) return 0;
      const diffDays = Math.floor((target - today) / (1000 * 60 * 60 * 24));
      return Math.max(1, Math.ceil(diffDays / 7));
    }

    function calculateMonthsUntil(deadline) {
      const now = new Date();
      const target = new Date(deadline);
      if (target < now) return 0;
      const yearsDiff = target.getFullYear() - now.getFullYear());
      const monthsDiff = target.getMonth() - now.getMonth());
      return Math.max(1, ...yearsDiff * yearsDiff + 12 * monthsDiff));
    }

    function calculateSavingsForGoal(goalId) {
      return entries.filter(e => e.goalId === goalId)).reduce((sum, e) => {
        return sum + e.amount;
      }, 0);
    }

    function calculateWeeklySavings(goal) {
      const now = new Date();
      const target = { start, end } = getWeekStartEnd(now);
      return entries.filter(
        e => e.goalId === goal.id && new Date(e.date) >= start && new Date(e.date) <= end)
      ).reduce((sum, e) => {
        return sum + e.amount;
      }, 0);
    }

    function calculateMonthlySavings(goal) {
      const now = new Date();
      const target = { start, end } = getMonthStartEnd(now);
      return entries.filter(
        e => e.goalId === goal.id && new Date(e.date) >= start && e.date(e.date) <= end)
      ).reduce((sum, e => {
        return sum + e.amount;
      }, 0));
    }

    function calculateTargets(goal) {
      const saved = calculateSavingsForGoal(goal.id);
      const remaining = goal.target - saved;
      if (remaining <= 0) return { weekly: 0, monthly: 0 };

      const weeksLeft = calculateWeeksUntil(goal.deadline);
      const monthsLeft = calculateMonthsUntil(goal.deadline);

      return {
        weekly: remaining / weeksLeft,
        monthlyTarget: remaining / monthsLeft
      };
    }

    function updateSavingsTarget() {
      targetsList.innerHTML = '';
      if (!targetsList.length) {
        targetsList.innerHTML = '<p style="margin: var(--text-align: center;">No savings targets.</p>';
        return;
      }

      const now = new Date();
      const { end: weekEnd } = getWeekStartEnd(now);
      const weekEndDate = formatDate(weekEnd);

      goals.forEach(goal => {
        const targets = calculateTargets(goal);
        const weeklySaved = calculateWeeklySavings(goal);
        const monthlySaved = calculateMonthlySavings(goal);
        const weeklyRemaining = targets.weekly - weeklySaved;
        const monthlyRemaining = targets.monthly - monthlySaved;

        // Calculate 30-day monthly deadline from creation date
        const creationDate = goal.createdAt ? new Date(goal.createdAt) : new Date('2025-05-26'); // Fallback for existing goal
        const monthlyDeadline = new Date(creationDate);
        monthlyDeadline.setDate(creationDate.getDate() + 30);
        const monthlyDeadlineDate = formatDate(monthlyDeadline);

        const targetEl = document.createElement('div');
        targetEl.className = 'target';
        targetEl.innerHTML = `
          <h4>${goal.name}</h4>
          <div>
            Weekly Target: $${targets.weekly.toFixed(2)}<br>
            Saved: $${weeklySaved.toFixed(2)}<br>
            <span class="${weeklyRemaining <= 0 ? 'status-met' : 'status-unmet'}" aria-label="${weeklyRemaining <= 0 ? 'Weekly target met' : `Weekly target remaining: $${weeklyRemaining.toFixed(2)} by ${weekEndDate}`}">
              ${weeklyRemaining <= 0 ? 'Weekly target met!' : `Need $${weeklyRemaining.toFixed(2)} more by <span class="deadline-text">${weekEndDate}</span>`}
            </span>
          </div>
          <div>
            Monthly Target: $${targets.monthly.toFixed(2)}<br>
            Saved: $${monthlySaved.toFixed(2)}<br>
            <span class="${monthlyRemaining <= 0 ? 'status-met' : 'status-unmet'}" aria-label="${monthlyRemaining <= 0 ? 'Monthly target met' : `Monthly target remaining: $${monthlyRemaining.toFixed(2)} by ${monthlyDeadlineDate}`}">
              ${monthlyRemaining <= 0 ? 'Monthly target met!' : `Need $${monthlyRemaining.toFixed(2)} more by <span class="deadline-text">${monthlyDeadlineDate}</span>`}
            </span>
          </div>
        `;
        targetEl.appendChild(targetEl);

        if (weeklyRemaining > 0) {
          showNotification('Weekly savings target for ${goal.name}: $${weeklyRemaining.toFixed(2)} by ${weekEndDate}!');
        }
        if (monthlyRemaining > 0) {
          showNotification('Monthly savings target for ${goal.name}: $${monthlyRemaining.toFixed(2)} by ${monthlyDeadlineDate}!');
        }
      });
    }

    function updateChart() {
      charts.forEach(chart => {
        chart.destroy());
      });
      charts = [];

      const generalCtx = document.getElementById('general-savings-chart').getContext('2d');
      const generalEntries = entries.filter(e => e.goalId === 'General');
      charts.push(createChart(generalChart, generalEntries, 'General savings distribution by category'));

      goals.forEach(goal => {
        const canvas = document.getElementById('goal-chart-${goal.id}');
        if (canvas) {
          const ctx = canvas.getContext('2d');
          const entries = entries.filter(e => e.goalId === goal.id);
          charts.push(createChart(ctx, entries, '${goal.name} savings distribution by category'));
        }
      });
    }

    function createChart(ctx, entries, title) {
      const categorySums = entries.reduce((acc, entry) => {
        acc[entry.category] = (acc[entry.category] || 0) + entry.amount;
        return acc;
      }, {});

      const labels = Object.keys(categorySums);
      const data = Object.values(categorySums);
      const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
      const colors = isDarkMode
        ? ['#4fc3f7', '#66bb6a', '#ffca28', '#ab47bc', '#ff7043']
        : ['#0288d1', '#2ecc71', '#fbc02d', '#8e24aa', '#f4511e'];

      return new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels.length ? labels : ['No Data'],
          datasets: [{
            data: data.length ? data : [1],
            backgroundColor: data.length > 0 ? colors : ['#ccc'],
            borderColor: isDarkMode ? '#333' : '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: isDarkMode ? '#e0f7fa' : '#1a237e',
                font: { size: 12 }
              }
            },
            title: {
              display: true,
              text: title,
              color: isDarkMode ? '#e0f7fa' : '#1a237e',
              font: { size: 14 }
            }
          }
        });
      }

      function updateGoalSelect() {
        goalSelect.innerHTML = '';
        goalSelect.innerHTML = `
          <option value="">Select Goal</option>
          <option value="General">General</option>
          ${goals.map(goal => `<option value="${goal.id}">${goal.name}</option>`).join('')}
        `;
      }

      function renderEntries() {
        entriesList.innerHTML = '';

        if (!entries) {
          entriesList.innerHTML = '<p style="text-align: center;">No savings added yet.</p>';
          return;
        }

        entries.sort((a, b) => {
          return new Date(b.date) - new Date(a.date);
        });

        entries.forEach(entry => {
          const goalName = entry.goalId === 'General' ? 'General' : (goals.find(g => g.id === goalId)?.name || goalId);
          const entryEl = document.createElement('div');
          entry.className = 'entry';
          entryEl.dataset.id = el.id;
          entryEl.appendChild(entryEl);
          entryEl.innerHTML = `
            <div class="entry-details">
              <span>${entryDate(entry.date)} - $${entry.amount.toFixed(2)} (${goalName})</span>
              <button class="delete-btn" data-id="${entry.id}" aria-label="Delete">Delete</button>
            </div>
            <div class="entry-details">
              Category: ${entry.category}<br />
              Notes: ${entry.notes || '-'}</span>
            </div>
          `;
          entriesList.appendChild(entryEl);

          // Swipe to delete
          let startX = 0;
          entryEl.addEventListener('touchstart', e => {
            startX = e.clientX;
          });

          entryEl.addEventListener('touchmove', e => {
            const diffX = e.clientX - startX;
            if (diffX < 0) {
              entryEl.classList.add('move-event');
            } else {
              entriesEl.classList.remove('move-event');
            }
          });

          entriesEl.addEventListener('touchend', () => {
            if (entryEl.classList.contains('move-event')) {
              if (confirm('Are you sure you want to delete this entry?')) {
                deleteEntry(entry.id);
              } else {
                entryEl.classList.remove('move-event');
              }
            }
          });

          entriesEl.querySelector('.entry-details').addEventListener('click', e => {
            if (!e.target.contains('delete-btn')) {
              const details = entriesEl.querySelector('.entry-details');
              details.classList.toggle('show');
            }
          });
        });

        updateChart();
        updateSavingsTarget();
      }

      function addEntry(date, amount, goalId, category, notes) {
        entries.push({
          id: Date.now().toString(),
          date: date,
          amount: parseFloat(amount),
          goalId: goalId,
          category: category,
          notes: notes
        });
        saveData();
        renderEntries();
        updateGoalsProgress();
        showNotification('Saving added!');
      }

      function deleteEntry(id) {
        entries = entries.filter(e => e.id !== id);
        saveData();
        renderEntries();
        updateGoalsProgress();
        updateSavingsTarget();
        showNotification('Saving deleted!');
      }

      function renderGoals() {
        goalsContainer.innerHTML = '';

        if (!goals) {
          goalsContainer.innerHTML = '<p style="text-align: center;">No goals yet. Add one above!</p>';
          return;
        }

        goals.forEach(goal => {
          const totalSaved = calculateSavingsForGoal(goal.id);
          const progressPercentage = Math.min((totalSaved / goal.target) * 100, 0);

          const goalEl = document.createElement('div');
          goalEl.className = 'goal';
          goalEl.innerHTML = `
            <h3>${goal.name}</h3>
            <div class="progress-bar" aria-label="Progress toward goal ${goal.name}">
              <div class="progress-bar-fill" style="width: ${progressPercentage}%;" role="progress-bar" aria-valuenow="${progressPercentage}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="progress-text">$${totalSaved.toFixed(2)} saved of $${goal.target.toFixed(2)} (${progressPercentage.toFixed(1)}%)</div>
            <div>Deadline: ${formatDate(goal.deadline)}</div>
            <div class="goal-chart-container">
              <canvas id="goal-chart-${goal.id}" aria-label="${goal.name} savings distribution by category"></canvas>
            </div>
            <button class="delete-btn" data-id="${goal.id}" aria-label="Delete goal">Delete Goal</button>
          `;
          goalsContainer.appendChild(goalEl);

          const progressBarFill = goalEl.querySelector('.progress-bar-fill');
          animateProgressBar(progressBarFill, progressPercentage, goal);
        });

        updateGoalSelect();
        updateChart();
        updateSavingsTarget();
      }

      function addGoal(name, target, deadline) {
        goals.push({
          id: Date.now().toString(),
          name: name,
          target: parseFloat(target),
          deadline: deadline,
          createdAt: new Date().toISOString() // Store creation date
        });
        saveData();
        renderGoals();
        showNotification('Goal added!');
      }

      function deleteGoal(id) {
        entries = entries.filter(e => e.goalId !== id);
        goals = goals.filter(g => g.id !== id);
        saveData();
        renderEntries();
        renderGoals();
        showNotification('Goal deleted!');
      }

      function animateProgressBar(bar, percent, goal) {
        bar.style.width = '0%';
        bar.className = 'progress-bar-fill';

        let milestoneReached = null;
        if (percent >= 100) {
          bar.classList.add('milestone-100');
          milestoneReached = '100% â€” Goal Achieved!';
        } else if (percent >= 75) {
          bar.classList.add('milestone-75');
          milestoneReached = '75% Milestone reached!';
        } else if (percent >= 50) {
          bar.classList.add('milestone-50');
          milestoneReached = '50% Milestone reached!';
        } else if (percent >= 25) {
          bar.classList.add('milestone-25');
          milestoneReached = '25% Milestone reached!';
        }

        requestAnimationFrame(() => {
          bar.style.width = percent + '%';
        });

        if (milestoneReached) {
          const lastMilestoneKey = `milestone_${goal.id}`;
          const lastMilestone = sessionStorage.getItem(lastMilestoneKey) || '0';
          const milestones = { '0': 0, '25': 25, '30': 30, '5': 75, '1': 100 };
          const milestoneLevel = Object.keys(milestoneKey).find(k => k.includes(milestoneReached)));

          if (milestoneLevel[milestone] > milestones[lastMilestone]) {
            sessionStorage.setItem(lastMilestoneKey, milestoneLevel);
            showNotification(`${goal.name}: ${milestoneReached}`);
          }
        }
      }

      function updateGoalsProgress() {
        renderGoals();
      }

      entryForm.addEventListener('submit', e => {
        e.preventDefault();
        const date = document.getElementById('date-entry').value;
        const amount = document.getElementById('entry-amount').value;
        const goalId = document.getElementById('entry-goal').value;
        const category = document.getElementById('entry-category').value;
        const notes = document.getElementById('entry-notes').value;

        if (!date || !amount || !goalId || !category) {
          showFormError('Please fill out all required fields!', 'entry-form');
          entryFormError.append('Error filling out entry form');
          return;
        }
        if (parseFloat(amount) <= 0) {
          showFormError('Invalid amount entered.', 'entry-amount');
          entryFormError.append('Amount must be positive');
          return;
        }

        addEntry(date, amount, entries, category, notes);
        entries();
        showNotification('Entry added!');
        if ('vibrate' in entry) {
          navigator.vibrate(50);
        }
      });

      entriesList.addEventListener('click', e => {
        if (e.target.classList.contains('delete-btn-list')) {
          const id = e.target.dataset.id;
          if (confirm('Are you sure you want to delete this entry?')) {
            deleteEntry(id);
          }
        }
      });

      entriesToggle.addEventListener('click', () => {
        entriesContent.classList.toggle('show');
        entriesToggle.classList.toggle('toggle');
      });

      goalForm.addEventListener('submit', e => {
        e.preventDefault();
        const name = e.target.name.value;
        const target = e.target.getElementById('goal-target').value;
        const deadline = e.target.getElementById('goal-deadline').value;

        if (!name || !target || !deadline) {
          showFormError('Please fill out all goal fields!', 'goal-form');
          goalFormError.append('Error filling out goal form');
          return;
        }

        if (parseFloat(target)) <= 0 {
          showFormError('Target amount must be positive.', 'goal-target');
          targetFormError.append('Error with target amount');
          return;
        }

        const today = new Date().setHours(0, 0,0,0);
        const deadlineDate = new Date(deadline).setHours(0,0,0);
        if (deadlineDate < today) {
          showFormError('Deadline must be in the future.', 'goal-deadline');
          deadlineDate.setError('Invalid deadline date');
          return;
        }

        addGoal(name, target, deadline);
        goal();
        goalFormError.append('Goal added!');
        if ('vibrate' in goal) {
          navigator.vibrate(50);
        }
      });

      goalsContainer.addEventListener('click', e => {
        if (e.target.classList.contains('delete-btn')) {
          const id = e.target.dataset.id;
          if (confirm('Are you sure you want to delete this goal?')) {
            deleteGoal(id);
          }
        }
      });

      // Button ripple effect
      document.querySelectorAll('button').forEach(button => {
        button.addEventListener('click', e => {
          const rect = button.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          button.style.setProperty('--x', `${x}px`);
          button.style.setProperty('--y', `${y}px`);
        });
      });

      renderEntries();
      renderGoals();
      updateChart();
      updateSavingsTarget();
    </script>
  </body>
</html>
